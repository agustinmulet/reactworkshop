---
title: Workshop - Paso 3
path: /paso-03/
index: 5
---

import { Tabs, TabList, Tab, TabPanels, TabPanel } from '@reach/tabs'

## Usando Netlify para nuestro proyecto

Bueno, como algunos habr√°n visto, casi todos mis slides y proyectos los tengo
subidos a [Netlify](https://www.netlify.com), es \(m√°s que\) un hosting bastante
copado y facilita mucho el subir proyectos hechos por ejemplo con
`create-react-app`. Tambi√©n tienen algo que se llama Netlify CLI (Command Line
Interface) y Netlify Functions. Es decir, vamos a usar varias cosas del paquete
de Netlify üòé

Antes que nada, vamos a usar una
[lambda function \(en ingl√©s\)](https://www.netlify.com/docs/functions/) para
mantener a salvo nuestra API key que tenemos en nuestro archivo
`.env.development.local`! Para los que hicieron la versi√≥n anterior de este
workshop, es parecido a lo que hac√≠amos antes, pero los amigotes de webtask
parece que no aceptan nuevos registros... üôÑ \(Gracias
[Iv√°n Meyer](https://twitter.com/ivanmeyer_) por avisarme\)

Empecemos por crear una carpeta en la ra√≠z de nuestro proyecto que se llame
`functions`, deber√≠a quedar a la misma altura que nuestro `package.json` y dem√°s
carpetas. Dentro de esa carpeta creamos un archivo con extensi√≥n js cuyo nombre
va a definir la url despu√©s a donde tengamos que hacer nuestro `fetch`, por
ejemplo le ponemos de nombre `getWeather.js`.

Ahora todo lo que tengamos ah√≠ adentro de nuestra _lambda function_ va a
funcionar como un estilo de backend para nosotros. Lo que vamos a hacer
b√°sicamente para pedir la data del clima ser√≠a algo as√≠:

`Frontend usando fetch -> Lambda Function usando request -> Apixu`

Explicado en palabras, desde nuestro frontend usando `fetch`, hacemos una
petici√≥n a una URL que apunta a nuestra Lambda Function, desde la cual usando
`request` hacemos la petici√≥n a Apixu. Luego la data fluye al rev√©s con la
respuesta de lo que nos retorne el servicio de Apixu. Si todav√≠a no se entiende
(es muy probable, porque no explico muy bien üòÖ),
[este link](https://blog.makeitreal.camp/que-es-un-api/#c√≥mo-funciona-un-web-api)
puede ser de gran ayuda.

Una vez adentro del archivo `getWeather.js`, vamos a crear un endpoint nuevo, el
cual debe quedar as√≠:

```javascript
exports.handler = (event, context, callback) => {
  //Ac√° va nuestro c√≥digo
}
```

Wow, y qu√© es eso? ü§™ Esto se parece un poco m√°s a c√≥mo ser√≠a c√≥digo en NodeJS
\(un poco nom√°s\), pero a no asustarse que hay que modificar un par de cosas y
ya lo sacamos andando üòâ Vamos de a poco: `exports.handler` representa nuestra
funci√≥n y es el punto de entrada cuando hagan una petici√≥n a nuestro endpoint,
la cual recibe por par√°metros un evento, un contexto y un\(a\) callback. Donde
**event** es un objeto donde vamos a tener datos de la petici√≥n que recibimos
del Frontend \(tipo de petici√≥n HTTP, ya sea GET, POST, etc., datos recibidos
del Frontend si es una petici√≥n POST; digamos que es donde pasa toda la magia\),
**context** pens√© que iba a tener un contexto desde d√≥nde se hac√≠a la petici√≥n o
algo as√≠ pero parece que no, entonces no le encuentro mucha utilidad ü§∑‚Äç‚ôÇÔ∏è y
**callback** es una funci√≥n que utilizamos para retornar data procesada al
frontend o avisamos que hubo un error.

- [Docu de Lambda Functions de AWS (son las que usamos con Netlify)](https://docs.aws.amazon.com/es_es/lambda/latest/dg/nodejs-prog-model-handler.html)
- [Docu de NodeJS para leer m√°s sobre transacciones HTTP (en ingl√©s)](https://nodejs.org/en/docs/guides/anatomy-of-an-http-transaction/)

Empecemos por chequear qu√© tipo de petici√≥n nos estar√≠an haciendo, nosotros
desde el Frontend vamos a hacer una petici√≥n de tipo `GET` utilizando `fetch()`
como ya hicimos. La informaci√≥n de la petici√≥n la encontramos en
`event.httpMethod`, as√≠ que dentro de nuestra funci√≥n hacemos:

```javascript
exports.handler = (event, context, callback) => {
  //Chequeamos el tipo de petici√≥n HTTP, puede ser GET, POST...
  if (event.httpMethod === 'GET') {
    //Ac√° tenemos que buscar la data a apixu y retornarla en el
    //body de un objeto usando la funci√≥n callback
  }
}
```

Bien, ahora tenemos que traernos la direcci√≥n de la API que nos la traemos del
Frontend y necesitamos una forma de traernos la data porque `fetch()` no nos
sirve ac√° \(en el "backend"\). Empecemos por tener la URL de la API a mano as√≠
despu√©s la usamos para ir a buscar la data, en el rengl√≥n siguiente al
`exports.handler` y afuera del `if` nos guardamos la URL de la petici√≥n a apixu
en una constante:

```javascript
const request_url = `https://api.weatherbit.io/v2.0/forecast/daily?city=Buenos+Aires,Argentina&key=${process.env.REACT_APP_API_KEY}&days=7`
```

Por el momento vamos a dejar as√≠ como est√° la constante ya que la vamos a
configurar m√°s adelante de forma s√∫per f√°cil üòâ

Buen√≠simo, ya tenemos la URL para buscar la data y sabemos que nuestra API key
va a estar a salvo. Ahora tenemos que ir a buscar la data a nuestra
`request_url` y retornarla en la respuesta de la funci√≥n `callback`. Para hacer
esto tenemos un paquete llamado `request` que es bastante intuitivo y copado,
vamos a agregarlo a nuestro proyecto y luego lo incorporamos en la Lambda
Function.

En la terminal, en la ra√≠z de nuestro proyecto corremos el siguiente comando:

```bash
npm install request --save
```

Y una vez que se instala ya podemos usarlo en `getWeather.js`, primero lo
importamos \(afuera de `exports.handler`, arriba de todo\):

```javascript
const request = require('request')
```

Un momento, que importar no se hace con `import`? No me mientas, Agustin! ü§¨
Bueno, no, no les miento üòÖ como dijimos que esto funcionar√≠a como un backend,
as√≠ es como se importan paquetes en NodeJS por ejemplo.

Ahora que ya lo tenemos importado, vamos a usarlo! Agregamos esto adentro de
nuestro `if`:

```javascript
if (event.httpMethod === 'GET') {
  request.get(request_url, function(error, res, body) {
    if (error) {
      callback(null, {
        statusCode: 500,
        body: error,
      })
    } else {
      callback(null, {
        statusCode: 200,
        body: body,
      })
    }
  })
}
```

Pero esto cada vez se complica m√°s! ü§¨ü§¨ü§¨ Bueno, parece complejo pero yo creo
que explicando cada parte se entiende bien lo que estamos haciendo: Con
`request.get` vamos a ir a buscar a nuestra URL la data de apixu, luego esa data
que se consiga, se recibe en la funci√≥n que est√° como segundo par√°metro de
`get`, en la cual tendremos en `error` el objeto de error si llegase a haber
alguno \(crucemos los deditos para que no ü§û\), en `res` tendremos otro objeto
de respuesta de esta funci√≥n y en `body` vamos a tener la data que recibamos de
hacer el `request.get` a la API de apixu, es decir, el JSON que antes obten√≠amos
al hacer el `fetch()` en el Frontend. Luego chequeamos si hay un error, y si lo
hay retornamos en la funci√≥n `callback` dos par√°metros: el primero se utiliza
para informar errores, pero vamos a enviar `null` para luego poder enviar al
Frontend un objeto \(como segundo par√°metro\) informando el c√≥digo de estado 500
\(c√≥digo de error\) y un `body` con los detalles del error. Lo mismo hacemos
despu√©s, en el caso que no haya habido fallo, informamos un c√≥digo de estado 200
\(todo ok ‚úÖ\) y en `body` mandamos lo que nos retorna el resultado de la API de
Apixu.

Con esto podr√≠amos decir que ya estar√≠a hecha la _Lambda Function_ de manera
b√°sica para hacer lo que necesitamos: No exponer nuestra API key y que nos
busque la data que necesitamos. Nos deber√≠a haber quedado algo as√≠:

<Tabs>
<TabList>
    <Tab>Soluciones</Tab>
    <Tab>getWeather.js</Tab>
</TabList>

<TabPanels>

<TabPanel>
  Para ver la soluci√≥n de cada archivo hac√© click en las pesta√±as üëÜ
</TabPanel>

<TabPanel>

```javascript
const request = require('request')

exports.handler = (event, context, callback) => {
  const request_url = `https://api.weatherbit.io/v2.0/forecast/daily?city=Buenos+Aires,Argentina&key=${process.env.REACT_APP_API_KEY}&days=7`
  if (event.httpMethod === 'GET') {
    request.get(request_url, function(error, res, body) {
      if (error) {
        callback(null, {
          statusCode: 500,
          body: error,
        })
      } else {
        callback(null, {
          statusCode: 200,
          body: body,
        })
      }
    })
  }
}
```

</TabPanel>
</TabPanels>
</Tabs>

Ahora nos falta conectar el Frontend a nuestro endpoint! Esto nos lo simplifica
bastante Netlify, nuestra funci√≥n va a estar en:
`/.netlify/functions/NOMBRE_DE_FUNCION`, en nuestro caso va a ser
`/.netlify/functions/getWeather`. Copiamos el texto y vamos al Frontend de
nuestra app, donde hicimos el `fetch()` y pegamos la URL nueva adentro.
Guardamos el archivo y seguimos, vamos a probar si todo funciona!

<Tabs>
<TabList>
    <Tab>Soluciones</Tab>
    <Tab>C√≥mo deber√≠a quedar nuestro fetch</Tab>
</TabList>

<TabPanels>

<TabPanel>
  Para ver la soluci√≥n de cada archivo hac√© click en las pesta√±as üëÜ
</TabPanel>

<TabPanel>

```javascript
componentDidMount() {
  fetch(
    `/.netlify/functions/getWeather`
  )
  .then(result => result.json())
  .then(jsonData => {
    const current = jsonData.data.shift()
    const forecast = jsonData.data
    const location = {
      city_name: jsonData.city_name,
      country_code: jsonData.country_code,
      state_code: jsonData.state_code,
    }
    this.setState({ current, forecast, location, isLoaded: true })
  })
}
```

</TabPanel>
</TabPanels>
</Tabs>

## Haciendo deploy de nuestra app

Antes que nada, al haber hecho nuestra funci√≥n, debemos indicarle a Netlify en
qu√© carpeta de nuestro proyecto tiene que buscarla, as√≠ que creamos un archivo
en la ra√≠z de nuestro proyecto y le ponemos de nombre `netlify.toml`, adentro
escribimos lo siguiente:

```yaml
[build]
functions = './functions'
```

Como s√© que hay personas que no conf√≠an en los permisos de third parties sobre
c√≥digo de Github, vamos a ver dos formas de hacerlo:

- [Vinculando nuestro Github](#vinculando-nuestro-github)
- [Sin vincular nuestro Github](#sin-vincular-nuestro-github)

### Vinculando nuestro Github

Si vinculamos nuestra cuenta de [Github](https://www.github.com), para subir
nuestro proyecto es tan simple como entrar a nuestro usuario en Netlify y
decirle cu√°l es el proyecto del que queremos que haga el `deploy`, pero para eso
primero tenemos que subir nuestra app del clima a un repo nuestro, no? Peque√±o
detalle üòú Comencemos por entrar a nuestro usuario de Github, a la parte de
repositorios y creemos uno nuevo con el bot√≥n verde **New** que est√° a la
derecha, o [entrando en este link](https://www.github.com/new). Luego escribimos
un nombre para nuestro repositorio \(por ejemplo "ClimaApp"\) y no hace falta
que pongamos descripci√≥n ni que lo inicialicemos con un README. Vamos al bot√≥n
de abajo de todo y terminamos de crear nuestro repositorio. Se nos va a crear un
repositorio vac√≠o y el mismo Github que es re copado nos va a decir c√≥mo subir
nuestro proyecto donde dice
`‚Ä¶or push an existing repository from the command line`. Entonces abrimos una
terminal y vamos hasta la carpeta ra√≠z de nuestra app, luego ah√≠ hacemos lo que
nos dice Github:

```bash
git remote add origin https://github.com/agustinmulet/ClimaApp.git
git push -u origin master
```

Es probable que nos pida nuestro usuario y constrase√±a de Github, en ese caso
ingresamos nuestras credenciales y si todo sali√≥ bien, ya tenemos nuestra app
subida a un repo propio!

Ahora resta hacer lo que dije antes, entrar con nuestro usuario a Netlify, hacer
click en el bot√≥n verde de arriba a la derecha que dice **New site from Git** e
indicarle cu√°l es el repositorio con nuestra app \(ClimaApp si le pusieron el
mismo nombre que yo\), esperamos un poco que haga el deploy y ya \(casi\) est√°!
Lo que s√≠, Netlify nos da un nombre raro para nuestro sitio, as√≠ que podemos ir
a [**Cambiando la URL**](#cambiando-la-url).

### Sin vincular nuestro Github

Si no te gusta andar vinculando tu Github con cualquier cosa, o si no us√°s o no
ten√©s Github, no te preocupes, se puede subir nuestro proyecto igual üòä

Empecemos por instalarnos la CLI de Netlify de forma global, en la terminal
corremos:

```bash
npm i -g netlify-cli
```

Y luego nos hacemos cuenta en [Netlify](https://www.netlify.com) y logueamos con
nuestra cuenta de Netlify \(en la terminal\):

```bash
netlify login
```

Para hacer el deploy, necesitamos nuestra app lista para producci√≥n, la
generamos corriendo el siguiente comando:

```bash
npm run build
```

Y vamos a ver que se crea una carpeta `build` con nuestra app lista para hacer
el deploy, pero usamos la CLI para hacer esto as√≠ se sube la funci√≥n que hicimos
y dejamos que Netlify haga un poquito de su magia.

‚ö†Ô∏è Ni√±as y ni√±os, no intenten esto en sus casas ‚ö†Ô∏è ü§£ü§£

Vamos entonces con el deploy a producci√≥n, en la terminal:

```bash
netlify deploy --prod
```

Esto nos va a indicar que no tenemos nuestro proyecto vinculado a ning√∫n sitio
existente en Netlify, pero nosotros queremos hacer uno nuevo, as√≠ que con las
flechitas seleccionamos `Create & configure a new site` y luego nos pregunta un
nombre para nuestro sitio \(podemos hacerlo ahora o luego en
[**Cambiando la URL**](#cambiando-la-url)\). Lo siguiente que consulta es en qu√©
"Team" queremos agregar nuestro proyecto, si no les pregunta esto seguramente
les pida usuario y contrase√±a porque no se loguearon antes, no pasa nada.

Luego crea nuestro sitio, nos informa URL de Admin, URL donde va a estar alojada
nuestra app y un ID de sitio \(el cual va a estar en un archivo
`/.netlify/state.json` de configuraci√≥n en nuestro proyecto\) y nos pide luego
el path donde est√° nuestra app preparada para hacer deploy, que es la carpeta
`build` que generamos antes, entonces escribimos **build** y apretamos enter y
ya \(casi\) est√°! Si no pudimos generar la url que quer√≠amos o queremos
cambiarla, en la siguiente secci√≥n podremos hacerlo.

### Cambiando la URL

Para cambiar el nombre al que querramos \(nombredeapp.netlify.com\), tenemos que
\(si es que estamos en el Dashboard principal de Netlify\) hacer click en
nuestra app reci√©n subida con nombre raro, hacer click en el bot√≥n
`‚öô Site Settings` y en la parte de `Site Information` vamos a ver otro bot√≥n
`Change site name`, donde podemos definir el nombre que querramos. Es probable
que alg√∫n nombre como ClimaApp est√© utilizado, pero podemos inventar algo usando
nuestro nombre, o alg√∫n nombre raro que se les ocurra \(climarino, weatherapp,
miappdelclima, loquesea jaja\).

### Agregando nuestra variable de entorno el proyecto

Lo √∫ltimo que tenemos que hacer para que nuestra app funcione bien! Hayas
elegido vincular con Github o no, la verdad que esta es la √∫nica forma que
encontr√© que realmente funciona para crear variables de entorno, porque
supuestamente al agregarla en el archivo `netlify.toml` se puede probar todo de
manera local usando Netlify Dev, pero al estar en Beta parece que faltan ajustar
algunos tornillos. \(O soy yo que no tengo idea de c√≥mo usarlo bien, si alguien
sabe que me avise [**este es mi Twitter**](https://twitter.com/AgustinDMulet)\)

Bueno basta de ch√°chara, la variable! Para esto vamos a `‚öô Site Settings` de
nuestro proyecto y ah√≠ dentro a `Build & deploy`, `Environment` y creamos una
nueva haciendo click en el bot√≥n `Edit variables`. Nos pide Clave / Valor, por
practicidad vamos a poner como clave el nombre que venimos usando
`REACT_APP_API_KEY`y como valor ponemos nuestra API key
`c4321dd709e94986a41d00XXXXXXXXXX` todo as√≠ sin comillas, solamente el texto.

Guardamos, es posible que tengamos que repetir el tema del deploy, pero bueno,
no es √≥ptimo pero es la forma que encontr√© que funciona...

**Listo!** Espero que hayan disfrutado este workshop y cualquier cosa que les
parezca mejorable o que no est√© claramente explicada, manden PR para poder hacer
un buen workshop de React desde cero y que m√°s gente pueda aprender.

Adem√°s, si tienen ganas, pongan una foto en Twitter de su app funcionando, para
contagiar a que m√°s personas lo hagan :) y pueden alterar el CSS, lo que
quieran!

## C√≥mo seguir desde ac√°?

Ahora la idea es ir mejorando lo que tenemos, les tiro un par de ideas de cosas
que se pueden hacer:

- Mostrar m√°s datos
- Reacomodar cosas en el layout
- Agregar un input y buscar el clima en distintas ciudades

Mil cosas m√°s se pueden hacer, pero esas me parecen copadas. Y si te anim√°s a
agregar el input para buscar en distintas ciudades, me gustar√≠a verlo! üòÑüòÑ
